var QARR={Widgets:{}};QARR.Widgets.StatusStats=Garnish.Base.extend({settings:null,data:null,$widget:null,$body:null,init:function(t,e){this.setSettings(e),this.$widget=$("#widget"+t),this.$body=this.$widget.find(".body:first")}}),QARR.Widgets.PendingItemsWidget=Garnish.Base.extend({$container:null,$items:null,$currentItem:null,type:null,limit:null,dragger:null,exclude:null,init:function(t){var e=this;this.exclude=[],this.$container=$(t),this.limit=this.$container.data("limit"),this.type=this.$container.data("type"),this.$items=this.$container.find(".list-item:not(.excluded)"),this.$items.length>0&&$.each(this.$items,function(t,i){var n=$(i).data("id");e.exclude.push(n),new QARR.Widgets.PendingItem(i,e)})},addPendingItem:function(t){new QARR.Widgets.PendingItem(t,this)},fetchNewExcludeIds:function(){var t=this;return this.exclude=[],$.each(this.$container.find(".list-item:not(.excluded)"),function(e,i){var n=$(i).data("id");t.exclude.push(n)}),this.exclude},fetchNewItem:function(){var t=this,e={type:this.type,limit:1,exclude:this.fetchNewExcludeIds()};Craft.postActionRequest("qarr/elements/fetch-pending-items",e,$.proxy(function(e,i){if(e.success){var n=$(e.template);0===e.count?0===t.fetchNewExcludeIds().length&&($('<div class="list-item excluded"><div class="item-wrapper"><p>'+Craft.t("qarr","No recent submissions")+"</p></div></div>"),t.$container.find(".list").html(n)):(t.$container.find(".list").append(n),n.addClass("new-item"),t.addPendingItem(t.$container.find(n)))}},this))}}),QARR.Widgets.PendingItem=Garnish.Base.extend({$item:null,$itemWrapper:null,$progress:null,$actionBtn:null,$approveItemBtn:null,$deleteItemBtn:null,$rejectItemBtn:null,elementId:null,type:null,dragger:null,margin:null,direction:null,parent:null,hud:null,dragStartMargin:null,init:function(t,e){this.parent=e,this.$item=$(t),this.$progress=this.$item.find(".progress"),this.$itemWrapper=this.$item.find(".item-wrapper"),this.$actionBtn=this.$item.find(".action-btn"),this.$approveItemBtn=this.$item.find(".approve-btn"),this.$deleteItemBtn=this.$item.find(".delete-btn"),this.$rejectItemBtn=this.$item.find(".reject-btn"),this.elementId=this.$item.data("id"),this.type=this.parent.type,this.dragger=new Garnish.BaseDrag(this.$item,{axis:Garnish.X_AXIS,onDragStart:$.proxy(this,"_onDragStart"),onDrag:$.proxy(this,"_onDrag"),onDragStop:$.proxy(this,"_onDragStop")}),this.addListener(this.$actionBtn,"click","performAction")},performAction:function(t){var e=this;t.preventDefault();var i=$(t.currentTarget).data("action-type");if("delete"===i){$form=$('<section class="hud-wrapper"><label for="">'+Craft.t("qarr","Are you sure?")+'</label></section><section class="hud-footer qarr-footer"><input type="button" class="btn-modal cancel" value="'+Craft.t("qarr","Cancel")+'"><input type="submit" class="btn-modal submit" value="'+Craft.t("qarr","Delete")+'"/></section>').appendTo(Garnish.$bod),this.hud=new Garnish.HUD(this.$deleteItemBtn,$form,{hudClass:"hud qarr-hud",bodyClass:"body",closeOtherHUDs:!1});var n=this.hud.$footer.find(".cancel");this.addListener(n,"click",function(){this.hud.hide(),this._putBack()}),this.hud.on("submit",function(t){e.deleteElement(),e.hud.hide()})}"reject"===i&&Craft.postActionRequest("qarr/elements/update-status",this.buildPayload("rejected"),$.proxy(function(t,i){t.success&&(Craft.cp.displayNotice(Craft.t("qarr","Item Rejected")),e.$rejectItemBtn.addClass("rejected"),e.$item.addClass("reject-item"),window.qarrnav._getPendingEntries(),setTimeout(function(){e.parent.fetchNewItem(),e.$item.remove()},500))},this))},deleteElement:function(){var t=this,e={id:this.elementId};Craft.postActionRequest("qarr/reviews/delete",e,$.proxy(function(e,i){e.success&&(Craft.cp.displayNotice(Craft.t("qarr","Item deleted")),t.$item.addClass("delete-item"),window.qarrnav._getPendingEntries(),setTimeout(function(){t.parent.fetchNewItem(),t.$item.remove()},700))},this))},showPositiveMenu:function(){var t=this;Craft.postActionRequest("qarr/elements/update-status",this.buildPayload("approved"),$.proxy(function(e,i){e.success&&(Craft.cp.displayNotice(Craft.t("qarr","Item Approved")),t.$approveItemBtn.addClass("approved"),t.$item.addClass("approve-item"),setTimeout(function(){window.qarrnav._getPendingEntries(),t.parent.fetchNewItem(),t.$item.remove()},500))},this))},buildPayload:function(t){return{id:this.elementId,status:t,type:this.type}},showNegativeMenu:function(){this.$item.addClass("other-menu")},_onSettle:function(){this.$item.removeClass("dragging"),this.$item.removeClass("other-menu")},_onDragStart:function(){this.$item.addClass("dragging"),this.dragStartMargin=this._getPosition()},_onDrag:function(){var t;this.$item.removeClass("other-menu"),(t="ltr"===Craft.orientation?this.dragStartMargin+this.dragger.mouseDistX:this.dragStartMargin-this.dragger.mouseDistX)<this._getLeftPull()?t=this._getLeftPull():t>0&&(t=t<this._getRightPull()?this.dragStartMargin+this.dragger.mouseDistX:this._getRightPull()),this.$itemWrapper.css(Craft.left,t)},_onDragStop:function(){var t=this._getPosition();t===this._getLeftPull()?this.showNegativeMenu():t!==this._getRightPull()&&this._putBack(),t===this._getRightPull()&&(this.showPositiveMenu(),this.$itemWrapper.css(Craft.left,this._getRightPull()))},_putBack:function(){this.$item.removeClass("dragging"),this.$item.removeClass("other-menu");var t={};t[Craft.left]=0,this.$itemWrapper.velocity("stop").velocity(t,QARR.Widgets.PendingItem.animationDuration)},_getLeftPull:function(){return-200},_getRightPull:function(){return 100},_getPosition:function(){return parseInt(this.$itemWrapper.css(Craft.left))}},{animationDuration:100,defaults:{value:"1",onChange:$.noop}}),Garnish.$doc.ready(function(){$("#widget-recent-reviews").length>0&&new QARR.Widgets.PendingItemsWidget("#widget-recent-reviews"),$("#widget-recent-questions").length>0&&new QARR.Widgets.PendingItemsWidget("#widget-recent-questions")});
