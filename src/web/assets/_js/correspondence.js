var QarrEmailCorrespondence,QarrEmailModal,QarrReplyToFeedback,QarrReplyModal;QarrEmailCorrespondence=Garnish.Base.extend({$btn:null,$btnText:null,$spinner:null,$waveLoaderContainer:null,$waveLoader:null,type:null,entryId:null,modal:null,wavifyOptions:{height:20,bones:3,amplitude:40,color:"#B289EF",speed:.45},init:function(e){this.$btn=$(e),this.entryId=$(e).data("entry-id"),this.type=$(e).data("type"),this.$btnText=this.$btn.find(".link-text"),this.$spinner=this.$btn.find(".spinner"),this.$waveLoaderContainer=this.$btn.parent().parent().find(".loader-container"),this.$waveLoader=this.$waveLoaderContainer.find(".wave-loader"),this.addListener(this.$btn,"click","openEmailModal")},openEmailModal:function(e){e.preventDefault(),this.modal?(delete this.modal,this.modal=new QarrEmailModal(this)):this.modal=new QarrEmailModal(this),this.modal.on("save",$.proxy(this,"sendEmail"))},sendEmail:function(e){var t=this,a=this,s=e.email;e={type:this.type,entryId:this.entryId,subject:s.subject,message:s.message},this.$btnText.addClass("hide"),this.$spinner.removeClass("hidden"),this.$waveLoader=$(".wave-loader").wavify(this.wavifyOptions),Craft.postActionRequest("qarr/correspondence/send-mail",e,$.proxy(function(e,s){"success"===s&&(t.$waveLoaderContainer.velocity({height:"150%"},2e3,function(){a.$waveLoaderContainer.css({height:"100%","background-color":"#B289EF"}),a.$waveLoader.kill()}),t.emailSent())},this)),this.modal.hide()},emailSent:function(){var e=this;this.$waveLoaderContainer.velocity({opacity:0},"fast",function(){e.$waveLoaderContainer.css({"pointer-events":"none"}),e.$btn.parent().html('<span class="mail-result">'+Craft.t("qarr","Mail sent!")+"</span>")})}}),QarrEmailModal=Garnish.Modal.extend({widget:null,init:function(e){var t,a;a=this,this.base(),this.widget=e,this.$form=$('<form class="modal fitted qarr-modal prompt-modal modal-blue">').appendTo(Garnish.$bod),this.setContainer(this.$form),t=$(['<div class="body">','<header class="header">','<span class="header-text">'+Craft.t("qarr","Sending Email")+"</span>",'<span class="icon"><i class="fa fa-mail-bulk"></i></span>',"</header>",'<div class="qarr-field custom-field field-white-bg">','<input class="text fullwidth" type="text" id="reply-subject" name="reply-subject" autocomplete="off">','<label id="reply-subject-label" for="reply-subject" data-label="'+Craft.t("qarr","Subject")+'" data-error-message="'+Craft.t("qarr","Subject cannot be blank.")+'">'+Craft.t("qarr","Subject")+"</label>",'<span class="qarr-error-icon"><i class="fa fa-exclamation-triangle"></i></span>',"</div>",'<div class="qarr-field custom-field field-white-bg">','<textarea id="reply-message" rows="6"></textarea>','<label id="reply-message-label" for="reply-message" data-label="'+Craft.t("qarr","Message")+'" data-error-message="'+Craft.t("qarr","Message cannot be blank.")+'">'+Craft.t("qarr","Message")+"</label>",'<span class="qarr-error-icon"><i class="fa fa-exclamation-triangle"></i></span>',"</div>",'<div class="buttons">','<input type="button" class="btn btn-modal cancel" value="'+Craft.t("qarr","Cancel")+'">','<input type="submit" class="btn btn-modal submit" value="'+Craft.t("qarr","Send")+'">',"</div>","</div>"].join("")).appendTo(this.$form),this.show(),this.$cancelBtn=t.find(".cancel"),this.$subjectInput=t.find("#reply-subject"),this.$messageInput=t.find("#reply-message"),new QarrInputField(this.$subjectInput.parent()),new QarrTextareaField(this.$messageInput.parent()),setTimeout($.proxy(function(){a.$subjectInput.focus()},this),100),this.addListener(this.$cancelBtn,"click","hide"),this.addListener(this.$form,"submit","save")},save:function(e){e.preventDefault(),this.$subject=this.$subjectInput.val(),this.$message=this.$messageInput.val();var t=this.$subjectInput.parent().find("label"),a=this.$messageInput.parent().find("label");this.email={subject:this.$subject,message:this.$message},this.$subjectInput.removeClass("has-error"),this.$messageInput.removeClass("has-error"),""===this.$subjectInput.val()&&""===this.$messageInput.val()?(""===this.$subjectInput.val()&&(this.$subjectInput.parent().addClass("has-error"),t.html(t.data("error-message"))),""===this.$messageInput.val()&&(this.$messageInput.parent().addClass("has-error"),a.html(a.data("error-message")))):this.trigger("save",{email:this.email})}}),QarrReplyToFeedback=Garnish.Base.extend({$btn:null,$responseContainer:null,$replyTextarea:null,$spinner:null,modal:null,reply:null,placeholder:null,type:null,replyId:null,elementId:null,authorId:null,init:function(e){this.$btn=$(e),this.$responseContainer=$(".panel-response"),this.$spinner=$(".panel-response .spinner"),this.type=this.$btn.data("type"),this.elementId=this.$btn.data("element-id"),this.authorId=this.$btn.data("author-id"),this.replyId=this.$btn.data("reply-id"),this.placeholder=this.$btn.data("placeholder"),this.addListener(this.$btn,"click","openReplyModal")},openReplyModal:function(e){e.preventDefault(),this.modal?(delete this.modal,this.modal=new QarrReplyModal(this)):this.modal=new QarrReplyModal(this),this.modal.on("save",$.proxy(this,"updateReply"))},updateReply:function(e){var t=this;this.$spinner.removeClass("hidden"),this.$responseContainer.find(".response-container").addClass("faded"),e={id:this.replyId,reply:this.reply,elementId:this.elementId,authorId:this.authorId},Craft.postActionRequest("qarr/replies/save",e,$.proxy(function(e,a){"success"===a&&($(".feedback-panel").addClass("has-response"),t.updateFeedbackHtml(e.response))},this)),this.modal.hide()},updateFeedbackHtml:function(e){var t=this,a=this;Craft.postActionRequest("qarr/replies/get-markup",e,$.proxy(function(e,s){e.success&&setTimeout($.proxy(function(){this.$responseContainer.html(e.template),Craft.cp.displayNotice(Craft.t("qarr","Reply added")),this.$spinner.addClass("hidden"),this.$responseContainer.find(".response-container").removeClass("faded"),new QarrReplyToFeedback("#reply-to-feedback-btn"),this.$btn.velocity({opacity:0},500,function(){a.$btn.hide()})},t),1e3)},this))}}),QarrReplyModal=Garnish.Modal.extend({widget:null,init:function(e){var t,a;a=this,this.base(),this.widget=e,this.$form=$('<form class="modal fitted qarr-modal prompt-modal">').appendTo(Garnish.$bod),this.setContainer(this.$form),t=$(['<div class="body">','<header class="header">','<span class="header-text">'+Craft.t("qarr","Reply to Feedback")+"</span>",'<span class="icon"><i class="fa fa-reply"></i></span>',"</header>",'<div class="qarr-field custom-field field-white-bg">','<textarea id="reply-text" rows="6"></textarea>','<label id="reply-text-label" for="reply-text" data-label="'+Craft.t("qarr","Reply Message")+'" data-error-message="'+Craft.t("qarr","Reply Message cannot be blank.")+'">'+Craft.t("qarr","Reply Message")+"</label>",'<span class="qarr-error-icon"><i class="fa fa-exclamation-triangle"></i></span>',"</div>",'<div class="buttons">','<input type="button" class="btn btn-modal cancel" value="'+Craft.t("qarr","Cancel")+'">','<input type="submit" class="btn btn-modal submit" value="'+Craft.t("qarr","Add")+'">',"</div>","</div>"].join("")).appendTo(this.$form),this.show(),this.$cancelBtn=t.find(".cancel"),this.$replyTextarea=t.find("#reply-text"),new QarrTextareaField(this.$replyTextarea.parent()),this.widget.placeholder&&this.$replyTextarea.val(this.widget.placeholder),setTimeout($.proxy(function(){a.$replyTextarea.focus()},this),100),this.addListener(this.$cancelBtn,"click","hide"),this.addListener(this.$form,"submit","save")},save:function(e){e.preventDefault(),this.reply=this.$replyTextarea.val(),this.widget.reply=this.reply;var t=this.$replyTextarea.parent().find("label");""===this.reply?""===this.$replyTextarea.val()&&(this.$replyTextarea.parent().addClass("has-error"),t.html(t.data("error-message"))):this.trigger("save",{reply:this.reply})}});
