var QarrTabs=Garnish.Base.extend({$container:null,$tabLinksContainer:null,$tabLink:null,$tabContentContainer:null,$tabContent:null,targetLink:null,target:null,selectedTab:"reviews",reviewsContainer:null,reviewsContent:null,reviewsDisplayId:null,questionsContainer:null,questionsContent:null,questionsDisplayId:null,init:function(t){this.$container=$(t),this.$tabLinksContainer=this.$container.find(".qarr-tab-links"),this.$tabLink=this.$tabLinksContainer.find(".qarr-tab-link"),this.$tabContentContainer=this.$container.find(".qarr-tab-container"),this.$tabContent=this.$container.find(".qarr-tab-content"),this.reviewsContainer=this.$tabContentContainer.find("[data-qarr-reviews]"),this.questionsContainer=this.$tabContentContainer.find("[data-qarr-questions]");var e={type:"review",displayId:this.reviewsContainer.data("display-id"),elementId:this.reviewsContainer.data("element-id")},i={type:"question",displayId:this.questionsContainer.data("display-id"),elementId:this.questionsContainer.data("element-id")};this.reviewsContent=new QarrTabContent(this.reviewsContainer,this,"review",e),this.questionsContent=new QarrTabContent(this.questionsContainer,this,"question",i),this.checkTabSelection(),this.addListener(this.$tabLink,"click","handleTabClick")},checkTabSelection:function(){window.localStorage.getItem("qarr-tab")&&(this.selectedTab=window.localStorage.getItem("qarr-tab")),this.updateTabSelection()},handleTabClick:function(t){t.preventDefault(),this.targetLink=$(t.currentTarget),this.target=this.targetLink.data("target"),this.selectedTab=this.target,window.localStorage.setItem("qarr-tab",this.target),this.updateTabSelection(this.targetLink)},updateTabSelection:function(t){this.$tabLink.removeClass("active"),"reviews"===this.selectedTab?this.showReviews():this.showQuestions()},showReviews:function(){$(".qarr-tab-link-reviews").addClass("active"),this.reviewsContainer.addClass("active"),this.questionsContainer.removeClass("active")},showQuestions:function(){$(".qarr-tab-link-questions").addClass("active"),this.questionsContainer.addClass("active"),this.reviewsContainer.removeClass("active")}}),QarrTabContent=Garnish.Base.extend({$container:null,$btn:null,type:null,displayId:null,elementId:null,modal:null,tabContext:null,init:function(t,e,i,n){this.tabContext=e,this.type=i,this.displayId=n.displayId,this.elementId=n.elementId,this.$container=$(t),this.$btn=this.$container.find(".qarr-open-modal"),this.addListener(this.$btn,"click","openModal")},openModal:function(t){t.preventDefault(),this.modal?(this.modal.$form.remove(),delete this.modal,this.modal=new QarrFeedbackModal(this)):this.modal=new QarrFeedbackModal(this),this.modal.on("onSaved",$.proxy(this,"sendPayload"))},sendPayload:function(t){var e=t.target;e.$form.addClass("has-sent"),e.$header.find("span").html("Form Submitted!"),e.$body.html('<div class="qarr-modal-message">Your submission is being reviewed.</div>'),e.updateSizeAndPosition(),setTimeout(function(){e.hide()},3e3)}}),QarrFeedbackModal=Garnish.Modal.extend({context:null,$form:null,$header:null,$body:null,$errorsContainer:null,$footer:null,init:function(t){var e=this;this.base(null,{shadeClass:"modal-shade dark qarr-modal-shade"}),this.context=t;var i={type:t.type,displayId:t.displayId,elementId:t.elementId};i[QARR.csrfTokenName]=QARR.csrfTokenValue,$.post(QARR.actionUrl+"qarr/frontend/get-modal-content",i,function(t,i,n){t.success&&e.initModal(t.template)})},initModal:function(t){this.$template=t,this.setContainer(this.$template),this.show(),this.$errorsContainer=this.$container.find(".qarr-errors"),this.$form=$("#qarr-modal-"+this.context.type),"review"===this.context.type&&new QarrStarRating(this.$form.find(".qarr-star-container")),this.$header=this.$form.find(".qarr-header"),this.$body=this.$form.find(".qarr-body"),this.$footer=this.$form.find(".qarr-footer"),this.$cancelBtn=this.$form.find(".cancel"),this.addListener(this.$cancelBtn,"click","hide"),this.addListener(this.$form,"submit","save")},save:function(t){t.preventDefault();var e,i=this,n=this.$form.serialize();e="review"===this.context.type?QARR.actionUrl+"qarr/reviews/save":QARR.actionUrl+"qarr/questions/save",$.post(e,n,function(t,e,n){t.success?i.trigger("onSaved",{data:"we are submitting.."}):(Garnish.shake(i.$container),i.formValidation(t))})},formValidation:function(t){var e=this;this.$errorsContainer.html(""),$(".qarr-field").removeClass("has-error"),$.each(t.errors,function(t,i){e.$errorsContainer.append("<li>"+i+"</li>"),$("#fields-"+t+"-"+e.context.type).addClass("has-error")}),this.updateSizeAndPosition()}}),QarrCheckboxes=Garnish.Base.extend({$container:null,$options:null,init:function(t){this.$container=$(t),this.$options=this.$container.find("input.checkbox"),this.addListener(this.$options,"change","onChange")},onChange:function(){}}),QarrRadioButtons=Garnish.Base.extend({$container:null,$options:null,init:function(t){this.$container=$(t),this.$options=this.$container.find("input"),this.addListener(this.$options,"change","onChange")},onChange:function(t){var e=$(t.currentTarget);this.$container.find("label").removeClass("selected"),e.parent().addClass("selected")}}),QarrInputField=Garnish.Base.extend({$el:null,$input:null,$label:null,$inputIcon:null,$noticeIcon:null,hadError:!1,labelText:null,errorMessage:null,init:function(t){this.$el=$(t),this.$input=this.$el.find("input"),this.$label=this.$el.find("label"),this.$inputIcon=this.$el.find(".qarr-input-icon"),this.$noticeIcon=this.$el.find(".qarr-notice-icon"),this.labelText=this.$label.data("label"),this.errorMessage=this.$label.data("error-message"),this.addListener(this.$input,"change","inputChange"),this.addListener(this.$input,"keyup","inputKeyup"),this.addListener(this.$input,"focus focusout","inputFocus"),this.$el.hasClass("custom-select")&&(this.addListener(this.$el.find("select"),"change","inputChange"),this.selectElement())},selectElement:function(){var t=this;this.$el.on("select2:opening",function(e){t.$el.addClass("has-focus")}),this.$el.on("select2:closing",function(e){t.$el.removeClass("has-focus")})},inputFocus:function(){this.checkInputFocus()},inputKeyup:function(){var t=this.$input.val();!t&&this.hadError&&(this.$el.addClass("has-error"),this.$label.html(this.errorMessage)),this.$el.hasClass("has-error")&&(this.hadError=!0,t&&(this.$el.removeClass("has-error"),this.$label.html(this.labelText)))},inputChange:function(){this.checkInputValue()},checkInputFocus:function(){this.$input.is(":focus")?this.$el.addClass("has-focus"):this.$el.removeClass("has-focus"),this.checkInputValue()},checkInputValue:function(){var t=this.$input.val();this.$el.hasClass("custom-select")&&(t=this.$el.find("select").select2("data"),this.$el.hasClass("has-error")&&(this.hadError=!0),this.hadError&&t&&(this.$el.removeClass("has-error"),this.$label.html(this.labelText))),t?this.$el.addClass("has-value"):this.$el.removeClass("has-value")}}),QarrTextareaField=Garnish.Base.extend({$el:null,$textarea:null,$label:null,$inputIcon:null,$noticeIcon:null,hadError:!1,labelText:null,errorMessage:null,init:function(t){this.$el=$(t),this.$textarea=this.$el.find("textarea"),this.$label=this.$el.find("label"),this.$inputIcon=this.$el.find(".qarr-input-icon"),this.$noticeIcon=this.$el.find(".qarr-notice-icon"),this.labelText=this.$label.data("label"),this.errorMessage=this.$label.data("error-message"),this.addListener(this.$textarea,"change","inputChange"),this.addListener(this.$textarea,"keyup","inputKeyup"),this.addListener(this.$textarea,"focus focusout","inputFocus")},inputFocus:function(){this.checkInputFocus()},inputKeyup:function(){var t=this.$textarea.val();!t&&this.hadError&&(this.$el.addClass("has-error"),this.$label.html(this.errorMessage)),this.$el.hasClass("has-error")&&(this.hadError=!0,t&&(this.$el.removeClass("has-error"),this.$label.html(this.labelText)))},inputChange:function(){this.checkInputValue()},checkInputFocus:function(){this.$textarea.is(":focus")?this.$el.addClass("has-focus"):this.$el.removeClass("has-focus")},checkInputValue:function(){this.$textarea.val()?this.$el.addClass("has-value"):this.$el.removeClass("has-value")}}),QarrStarRating=Garnish.Base.extend({$container:null,$star:null,$input:null,rating:null,init:function(t){this.$container=$(t),this.$star=this.$container.find(".qarr-star"),this.$input=this.$container.find("input"),this.addListener(this.$star,"click","updateRating")},updateRating:function(t){var e=$(t.currentTarget);this.$star.removeClass("selected"),this.$star.removeClass("active"),this.rating=e.data("star-count"),e.addClass("selected"),e.prevAll().addClass("active"),this.$input.val(this.rating)}}),QarrPagination=Garnish.Base.extend({$pagerContainer:null,$loader:null,$pagerBtn:null,direction:null,$nextBtn:null,$prevBtn:null,style:null,type:null,limit:null,offset:null,totalPages:null,currentPage:null,elementId:QARR.elementId,init:function(t){this.$pagerContainer=$(t),this.$loader=$(".qarr-loader"),this.$nextBtn=this.$pagerContainer.find(".qarr-pager-next"),this.$prevBtn=this.$pagerContainer.find(".qarr-pager-prev"),this.$pagerBtn=this.$pagerContainer.find(".qarr-pager"),this.style=this.$pagerContainer.data("style"),this.type=this.$pagerContainer.data("type"),this.totalPages=this.$pagerContainer.data("total-pages"),this.limit=parseInt(QARR.limit),this.offset=0,this.currentPage=1,this.addListener(this.$pagerBtn,"click","loadPage")},loadPage:function(t){t.preventDefault();var e=this,i=$("#qarr-"+this.type+"-container");this.direction=$(t.currentTarget).data("direction"),this.setOffset(),this.$loader.addClass("active"),i.addClass("transition");var n={type:this.type,limit:this.limit,offset:this.offset,elementId:this.elementId};n[QARR.csrfTokenName]=QARR.csrfTokenValue,$.post(QARR.actionUrl+"qarr/elements/query-elements",n,function(t,n,s){t.success&&(setTimeout(function(){e.$loader.removeClass("active"),"infinite"===e.style?i.append(t.template):i.html(t.template),$(".add-answer").on("click",function(t){t.preventDefault();var e={target:$(this),questionId:$(this).data("id"),authorName:$(this).data("user-name"),authorId:$(this).data("user-id")};new QarrAnswerHud(e)});var n=$(t.template).attr("id"),s=$("#"+n);$("html, body").animate({scrollTop:s.offset().top},"fast"),i.removeClass("transition")},1e3),e.checkOffset())})},setOffset:function(){"next"===this.direction?(this.offset=this.offset+this.limit,this.currentPage=this.currentPage+1):(this.offset=this.offset-this.limit,this.currentPage=this.currentPage-1)},checkOffset:function(){"next"===this.direction&&(this.currentPage===this.totalPages&&this.$nextBtn.addClass("pager-disabled"),1===this.currentPage&&0===this.offset||this.$prevBtn.removeClass("pager-disabled")),"prev"===this.direction&&(1!==this.currentPage&&0!==this.offset||this.$prevBtn.addClass("pager-disabled"),this.currentPage!==this.totalPages&&this.$nextBtn.removeClass("pager-disabled"))}}),QarrAnswerHud=Garnish.Base.extend({$container:null,$errorsContainer:null,questionId:null,authorId:null,authorName:null,$hudName:null,asCustomerText:null,asAnonymousText:null,anonymous:!1,hud:null,init:function(t){this.$container=$(t.target),this.questionId=t.questionId,this.authorId=t.authorId,this.authorName=t.authorName,this.getHud()},getHud:function(){var t=this,e={id:this.questionId,author:{id:this.authorId,name:this.authorName}};e[QARR.csrfTokenName]=QARR.csrfTokenValue,$.post(QARR.actionUrl+"qarr/answers/get-hud-modal",e,function(e,i,n){e.success&&t.createHud(e.template)})},createHud:function(t){var e=this;this.hud=new Garnish.HUD(this.$container,t,{hudClass:"hud qarr-hud",bodyClass:"body",closeOtherHUDs:!1}),this.$errorsContainer=this.hud.$body.find(".qarr-errors"),this.hud.on("hide",$.proxy(function(){delete this.hud,$(".hud-shade").remove(),$(".qarr-hud").remove()},this)),this.$hudName=this.hud.$body.find(".hud-name"),this.asCustomerText=this.$hudName.data("posting-customer"),this.asAnonymousText=this.$hudName.data("posting-anonymous"),this.hud.$body.find("textarea:first").trigger("focus").parent().addClass("has-focus");var i=new QarrTextareaField(".custom-textarea"),n=new QarrLightSwitch(".qarr-lightswitch"),s=this.hud.$footer.find(".cancel");this.addListener(s,"click",function(){this.hud.hide()}),n.$outerContainer.on("change",function(){e.anonymous="1"===n.$input.val(),e.updateAnonymous()}),this.hud.on("submit",function(t){var s=n.$input.val(),a=e.hud.$body.find("textarea").val();if(e.$errorsContainer.html(""),$(".qarr-field").removeClass("has-error"),""===a)Garnish.shake(e.hud.$body),i.$el.addClass("has-error"),e.$errorsContainer.append("<li>Answer is required</li>");else{i.$el.removeClass("has-error");var r={questionId:e.questionId,authorId:e.authorId,anonymous:s,answer:a};r[QARR.csrfTokenName]=QARR.csrfTokenValue,$.post(QARR.actionUrl+"qarr/answers/save",r,function(t,i,n){if(t.success){var s=t.template;e.hud.updateBody(s)}})}})},updateAnonymous:function(){this.anonymous?this.$hudName.find("span").html(this.asAnonymousText):this.$hudName.find("span").html(this.asCustomerText)}}),QarrStarFilterEntries=Garnish.Base.extend({$container:null,payload:null,type:null,rating:null,total:null,init:function(t){this.$loader=$(".qarr-loader"),this.$container=t.target,this.payload=t,this.type=t.type,this.rating=t.rating,this.total=t.total,this.addListener(this.$container,"click",this.fetchEntries)},fetchEntries:function(t){$(".qarr-pagination").hide(),t.preventDefault();var e=this,i=$("#qarr-"+this.type+"-container");this.$loader.addClass("active"),i.addClass("transition");var n={type:this.type,limit:QARR.limit,rating:this.rating,elementId:QARR.elementId};n[QARR.csrfTokenName]=QARR.csrfTokenValue,$.post(QARR.actionUrl+"qarr/elements/query-star-filtered-elements",n,function(t,n,s){t.success&&(setTimeout(function(){e.$loader.removeClass("active"),i.html(t.template);var n=$(t.template).attr("id"),s=$("#"+n);$("html, body").animate({scrollTop:s.offset().top},"fast"),i.removeClass("transition")},1e3),window.localStorage.setItem("qarr-star-filter",e.rating))})}}),QarrAnswersContainer=Garnish.Base.extend({$container:null,$answersContainer:null,$cta:null,ctaText:null,hideText:null,visible:!1,init:function(t){this.$container=$(t),this.$answersContainer=this.$container.find(".qarr-entry-more-answers-container"),this.$cta=this.$container.find("a"),this.ctaText=this.$cta.text(),this.hideText=this.$cta.data("hide-text"),this.addListener(this.$cta,"click","showAnswers")},showAnswers:function(t){t.preventDefault(),this.$container.hasClass("is-visible")?(this.$container.removeClass("is-visible"),this.visible=!1,this.animate()):(this.$container.addClass("is-visible"),this.visible=!0,this.animate())},animate:function(){var t=this.visible?"slideDown":"slideUp",e=this.visible?200:400;this.$answersContainer.velocity("stop").velocity(t,{easing:"easeOutQuart",duration:e,complete:$.proxy(function(){this.$cta.html(this.updateLinkText())},this)})},updateLinkText:function(){this.visible?this.$cta.html(this.hideText):this.$cta.html(this.ctaText)}}),QarrLightSwitch=Garnish.Base.extend({settings:null,$outerContainer:null,$innerContainer:null,$input:null,small:!1,on:null,dragger:null,orientation:"ltr",dragStartMargin:null,init:function(t,e){this.$outerContainer=$(t),this.$outerContainer.data("lightswitch",this),this.small=this.$outerContainer.hasClass("small"),this.setSettings(e,QarrLightSwitch.defaults),this.$innerContainer=this.$outerContainer.find(".lightswitch-container:first"),this.$input=this.$outerContainer.find("input:first"),this.$input.prop("disabled")||(this.on=this.$outerContainer.hasClass("on"),this.$outerContainer.attr({role:"checkbox","aria-checked":this.on?"true":"false"}),this.addListener(this.$outerContainer,"mousedown","_onMouseDown"),this.addListener(this.$outerContainer,"keydown","_onKeyDown"),this.dragger=new Garnish.BaseDrag(this.$outerContainer,{axis:Garnish.X_AXIS,ignoreHandleSelector:null,onDragStart:$.proxy(this,"_onDragStart"),onDrag:$.proxy(this,"_onDrag"),onDragStop:$.proxy(this,"_onDragStop")}))},turnOn:function(){this.$outerContainer.addClass("dragging");this.$innerContainer.velocity("stop").velocity({"margin-left":0},200,$.proxy(this,"_onSettle")),this.$input.val(this.settings.value),this.$outerContainer.addClass("on"),this.$outerContainer.attr("aria-checked","true"),this.on!==(this.on=!0)&&this.onChange()},turnOff:function(){this.$outerContainer.addClass("dragging");var t={};t["margin-left"]=this._getOffMargin(),this.$innerContainer.velocity("stop").velocity(t,200,$.proxy(this,"_onSettle")),this.$input.val(""),this.$outerContainer.removeClass("on"),this.$outerContainer.attr("aria-checked","false"),this.on!==(this.on=!1)&&this.onChange()},toggle:function(t){this.on?this.turnOff():this.turnOn()},onChange:function(){this.trigger("change"),this.settings.onChange(),this.$outerContainer.trigger("change")},_onMouseDown:function(){this.addListener(Garnish.$doc,"mouseup","_onMouseUp")},_onMouseUp:function(){this.removeListener(Garnish.$doc,"mouseup"),this.dragger.dragging||this.toggle()},_onKeyDown:function(t){switch(t.keyCode){case Garnish.SPACE_KEY:this.toggle(),t.preventDefault();break;case Garnish.RIGHT_KEY:"ltr"===this.orientation?this.turnOn():this.turnOff(),t.preventDefault();break;case Garnish.LEFT_KEY:"ltr"===this.orientation?this.turnOff():this.turnOn(),t.preventDefault()}},_getMargin:function(){return parseInt(this.$innerContainer.css("margin-left"))},_onDragStart:function(){this.$outerContainer.addClass("dragging"),this.dragStartMargin=this._getMargin()},_onDrag:function(){var t;(t="ltr"===this.orientation?this.dragStartMargin+this.dragger.mouseDistX:this.dragStartMargin-this.dragger.mouseDistX)<this._getOffMargin()?t=this._getOffMargin():t>0&&(t=0),this.$innerContainer.css("margin-left",t)},_onDragStop:function(){this._getMargin()>this._getOffMargin()/2?this.turnOn():this.turnOff()},_onSettle:function(){this.$outerContainer.removeClass("dragging")},destroy:function(){this.base(),this.dragger.destroy()},_getOffMargin:function(){return this.small?-9:-11}},{animationDuration:100,defaults:{value:"1",onChange:$.noop}});
