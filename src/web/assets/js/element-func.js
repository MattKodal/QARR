var FeedbackResponse=Garnish.Base.extend({$replyBtn:null,$replyDeleteBtn:null,$replyEditBtn:null,$container:null,$spinner:null,id:null,elementId:null,reply:null,modal:null,init:function(t){this.$container=t;var e=this.$container.find(".response-container");this.id=e.data("id"),this.elementId=e.data("element-id"),this.reply=e.data("reply"),this.$replyBtn=this.$container.find("#reply-to-feedback"),this.$replyEditBtn=this.$container.find("#edit-feedback-btn"),this.$replyDeleteBtn=this.$container.find("#delete-feedback-btn"),this.addListener(this.$replyEditBtn,"click","handleEditReply"),this.addListener(this.$replyDeleteBtn,"click","handleDeleteReply")},handleEditReply:function(){this.modal?(delete this.modal,this.modal=new ReplyModal(this,"edit",this.elementId)):this.modal=new ReplyModal(this,"edit",this.elementId)},handleDeleteReply:function(t){var e=this;t.preventDefault();var a={id:this.id};Craft.postActionRequest("qarr/replies/delete",a,$.proxy(function(t,a){t.success&&(Craft.cp.displayNotice(Craft.t("qarr","Reply deleted")),e.$container.html(""),$("#reply-to-feedback").removeClass("opacity-50 cursor-not-allowed").prop("disabled",!1))},this))}}),ReplyModal=Garnish.Modal.extend({$parentContainer:null,$form:null,$modalContainer:null,$errorContainer:null,$spinner:null,isValidate:!1,type:null,elementId:null,parent:null,init:function(t,e,a){this.base(),this.$parentContainer=Garnish.$bod.find(".response"),this.type=e,this.parent=t,this.elementId=a,t&&(this.id=t.id),this.$form=$('<form class="modal fitted qarr-modal prompt-modal">').appendTo(Garnish.$bod),this.setContainer(this.$form);var s=Craft.t("qarr","Add reply");"edit"===this.type&&(s=Craft.t("qarr","Update reply")),this.$modalContainer=$(['<div class="body">','<header class="header">',"<h2>"+Craft.t("qarr","Replying to Feedback")+"</h2>","</header>",'<label class="qarr-label">'+Craft.t("qarr","Reply message")+"</label>",'<textarea id="reply-text" class="qarr-textarea" rows="6" cols="70" placeholder="'+Craft.t("qarr","Leave a reply...")+'"></textarea>','<div class="error-container relative">','<span class="error-message absolute font-xs text-red-400 pt-2" data-error-message="'+Craft.t("qarr","Reply message cannot be blank.")+'"></span>',"</div>",'<div class="buttons right">','<span class="spinner hidden"></span>','<button type="button" class="cancel qarr-btn mr-2">'+Craft.t("qarr","Cancel")+"</button>",'<button type="submit" class="btn-modal submit qarr-btn btn-purple">'+s+"</button>","</div>","</div>"].join("")).appendTo(this.$form),this.show(),this.$cancelBtn=this.$modalContainer.find(".cancel"),this.$replyTextarea=this.$modalContainer.find("#reply-text"),this.$errorContainer=this.$modalContainer.find(".error-message"),this.$spinner=this.$modalContainer.find(".spinner"),"edit"===this.type&&this.$replyTextarea.val(this.parent.reply),setTimeout($.proxy(function(){this.$replyTextarea.focus()},this),100),this.addListener(this.$cancelBtn,"click","handleCancel"),this.addListener(this.$form,"submit","handleOk")},handleOk:function(t){var e=this;if(t.preventDefault(),this.validateForm(),this.isValidate){var a={id:this.id,reply:this.reply,elementId:this.elementId};Craft.postActionRequest("qarr/replies/save",a,$.proxy(function(t,a){"success"===a&&("new"===e.type?Craft.cp.displayNotice(Craft.t("qarr","Reply added")):Craft.cp.displayNotice(Craft.t("qarr","Reply updated")),e.$parentContainer.html(t.template),new FeedbackResponse(e.$parentContainer),$("#reply-to-feedback").addClass("opacity-50 cursor-not-allowed").prop("disabled",!0),e.handleSuccess())},this))}},validateForm:function(){this.reply=this.$replyTextarea.val(),this.$spinner.removeClass("hidden"),""===this.reply?(Garnish.shake(this.$container),this.$spinner.addClass("hidden"),this.$replyTextarea.addClass("border border-solid border-red-200"),this.$errorContainer.html(this.$errorContainer.data("error-message")),this.isValidate=!1):(this.$spinner.addClass("hidden"),this.$replyTextarea.removeClass("border border-solid border-red-200"),this.$errorContainer.html(""),this.isValidate=!0)},handleSuccess:function(){this.hide()},handleCancel:function(){this.hide()}}),QarrEmailCorrespondence=Garnish.Base.extend({$btn:null,$btnText:null,$loader:null,type:null,entryId:null,modal:null,init:function(t){this.$btn=$(t),this.entryId=$(t).data("element-id"),this.type=$(t).data("type"),this.$btnText=this.$btn.find(".link-text"),this.$loader=this.$btn.find(".loader"),this.addListener(this.$btn,"click","openEmailModal")},openEmailModal:function(t){t.preventDefault(),this.modal?(delete this.modal,this.modal=new QarrEmailModal(this)):this.modal=new QarrEmailModal(this),this.modal.on("save",$.proxy(this,"sendEmail"))},sendEmail:function(t){var e=this,a=t.email;t={type:this.type,entryId:this.entryId,subject:a.subject,message:a.message},this.$btnText.addClass("hide"),this.$loader.removeClass("hidden"),Craft.postActionRequest("qarr/correspondence/send-mail",t,$.proxy(function(t,a){console.log(t),"success"===a&&e.emailSent(t.entry)},this)),this.modal.hide()},emailSent:function(t){var e=this.$btn.parent().parent().find(".block-body"),a=$(['<div class="block-field mb-4">','<div class="text-xs opacity-50 mb-2">'+Craft.t("qarr","Sent now")+"</div>",'<div class="mb-2"><span class="font-semibold">'+Craft.t("qarr","Subject")+'</span> <p class="m-0">'+t.subject+"</p></div>",'<div class="mb-2"><span class="font-semibold">'+Craft.t("qarr","Message")+'</span> <p class="m-0">'+t.message+"</p></div>","</div>"].join(""));e.append(a),Craft.cp.displayNotice(Craft.t("qarr","Mail sent"))}}),QarrEmailModal=Garnish.Modal.extend({$body:null,isValid:!1,init:function(){var t=this;this.base(),this.$form=$('<form class="modal fitted qarr-modal prompt-modal modal-blue">').appendTo(Garnish.$bod),this.setContainer(this.$form),this.$body=$(['<div class="body">','<header class="header">',"<h2>"+Craft.t("qarr","Sending Email")+"</h2>","</header>",'<div class="qarr-field mb-4">','<label id="reply-subject-label" class="qarr-label" for="reply-subject" data-label="'+Craft.t("qarr","Subject")+'" data-error-message="'+Craft.t("qarr","Subject cannot be blank.")+'">'+Craft.t("qarr","Subject")+"</label>",'<input class="qarr-input" type="text" id="reply-subject" name="reply-subject" autocomplete="off">',"</div>",'<div class="qarr-field">','<label id="reply-message-label" class="qarr-label" for="reply-message" data-label="'+Craft.t("qarr","Message")+'" data-error-message="'+Craft.t("qarr","Message cannot be blank.")+'">'+Craft.t("qarr","Message")+"</label>",'<textarea id="reply-message" class="qarr-textarea qarr-input" rows="6" cols="60"></textarea>',"</div>",'<ul class="qarr-errors"></ul>','<div class="buttons right">','<button type="button" class="qarr-btn cancel mr-2">'+Craft.t("qarr","Cancel")+"</button>",'<button type="submit" class="qarr-btn btn-purple submit">'+Craft.t("qarr","Send")+"</button>","</div>","</div>"].join("")).appendTo(this.$form),this.show(),this.$cancelBtn=this.$body.find(".cancel"),this.$subjectInput=this.$body.find("#reply-subject"),this.$messageInput=this.$body.find("#reply-message"),setTimeout($.proxy(function(){t.$subjectInput.focus()},this),100),this.addListener(this.$cancelBtn,"click","hide"),this.addListener(this.$form,"submit","save")},save:function(t){var e=this;t.preventDefault();var a=this.$form.find(".qarr-errors");this.email={subject:this.$subjectInput.val(),message:this.$messageInput.val()},a.html(""),this.$subjectInput.removeClass("has-error"),this.$messageInput.removeClass("has-error"),$.each(this.email,function(t,a){""===a&&(e.isValid=!1)}),""===this.$subjectInput.val()||""===this.$messageInput.val()?(Garnish.shake(this.$container),""===this.$subjectInput.val()&&(this.$subjectInput.addClass("has-error"),a.append("<li>"+Craft.t("qarr","Subject is required")+"</li>")),""===this.$messageInput.val()&&(this.$messageInput.addClass("has-error"),a.append("<li>"+Craft.t("qarr","Message is required")+"</li>"))):this.trigger("save",{email:this.email}),this.updateSizeAndPosition()}}),QarrPrompt=Garnish.Base.extend({modal:null,$modalContainerDiv:null,$prompt:null,$promptChoices:null,init:function(t,e){this.showPrompt(t,e,$.proxy(this,"_handleSelection"))},showPrompt:function(t,e,a){this._promptCallback=a,null===this.modal&&(this.modal=new Garnish.Modal({closeOtherModals:!1})),null===this.$modalContainerDiv&&(this.$modalContainerDiv=$('<div class="modal fitted prompt-modal"></div>').addClass().appendTo(Garnish.$bod)),this.$prompt=$('<div class="body"></div>').appendTo(this.$modalContainerDiv.empty()),this.$promptMessage=$('<p class="prompt-msg"/>').appendTo(this.$prompt),this.$promptChoices=$('<div class="options"></div>').appendTo(this.$prompt),this.$promptButtons=$('<div class="buttons right"/>').appendTo(this.$prompt),this.modal.setContainer(this.$modalContainerDiv),this.$promptMessage.html('<div class="font-medium">'+t+"</div>");var s=$('<button class="cancel qarr-btn  mr-2">'+Craft.t("qarr","Cancel")+"</button>").appendTo(this.$promptButtons),i=$('<button type="submit" class="submit qarr-btn btn-purple">'+Craft.t("qarr","OK")+"</button>").appendTo(this.$promptButtons);if(e){i.addClass("disabled");for(var r=0;r<e.length;r++){var n=$('<div><label><input type="radio" name="promptAction" value="'+e[r].value+'"/> '+e[r].title+"</label></div>").appendTo(this.$promptChoices).find("input");this.addListener(n,"click",function(){i.removeClass("disabled")})}}this.addListener(i,"activate",function(t){if(this.choices){var e=$(t.currentTarget).parents(".modal").find("input[name=promptAction]:checked").val();this._selectPromptChoice(e)}else this._selectPromptChoice("ok")}),this.addListener(s,"activate",function(){this._selectPromptChoice("cancel")}),this.modal.show(),this.modal.removeListener(Garnish.Modal.$shade,"click"),this.addListener(Garnish.Modal.$shade,"click","_cancelPrompt")},_handleSelection:function(t){this.trigger("response",{response:t})},_selectPromptChoice:function(t){this.$prompt.fadeOut("fast",$.proxy(function(){this.modal.hide(),this._promptCallback(t)},this))},_cancelPrompt:function(){this._selectPromptChoice("cancel",!0)}}),Answers={};Answers.Container=Garnish.Base.extend({$container:null,$items:null,$loader:null,payload:null,init:function(t){parent=this,this.$container=$(t),this.$loader=this.$container.find(".loader"),this.$items=this.$container.find(".answer-item"),this.$items.length>0&&$.each(this.$items,function(t,e){new Answers.Answer(e,parent)})}}),Answers.Answer=Garnish.Base.extend({$item:null,$actionBtn:null,$statusLabel:null,id:null,questionId:null,parent:null,payload:null,init:function(t,e){this.parent=e,this.$item=$(t),this.$actionBtn=this.$item.find(".action-btn"),this.$statusLabel=this.$item.find(".answer-status"),this.payload={id:this.$item.data("id"),questionId:this.$item.data("parent-id")},this.addListener(this.$actionBtn,"click","performAction")},performAction:function(t){var e=this,a=this,s=t.target.dataset.actionType;if("delete"===s){var i=$('<section class="hud-wrapper"><label for="">'+Craft.t("qarr","Are you sure?")+'</label></section><section class="hud-footer qarr-footer mb-4"><button type="button" class="qarr-btn btn-small cancel">'+Craft.t("qarr","Cancel")+'</button><button type="submit" class="qarr-btn btn-purple btn-small submit">'+Craft.t("qarr","Delete")+"</button></section>").appendTo(Garnish.$bod);this.hud=new Garnish.HUD(t.target,i,{hudClass:"hud qarr-hud",bodyClass:"body",closeOtherHUDs:!1});var r=this.hud.$footer.find(".cancel");this.addListener(r,"click",function(){this.hud.hide()}),this.hud.on("submit",function(t){a.deleteElement(),a.hud.hide()})}"status"===s&&(this.parent.$loader.removeClass("hidden"),this.payload.status=t.target.dataset.status,Craft.postActionRequest("qarr/answers/update-status",this.payload,$.proxy(function(t,a){t.success&&(Craft.cp.displayNotice(Craft.t("qarr","Answer status updated")),e.$item.addClass("status-changed"),e.updateAnswer())},this)))},updateAnswer:function(){"approved"===this.payload.status?(this.$statusLabel.removeClass("rejected"),this.$statusLabel.addClass("approved"),this.$item.removeClass("rejected"),this.$item.addClass("approved")):(this.$statusLabel.removeClass("approved"),this.$statusLabel.addClass("rejected"),this.$item.removeClass("approved"),this.$item.addClass("rejected")),this.$statusLabel.html(this.payload.status),this.parent.$loader.addClass("hidden")},deleteElement:function(){var t=this;this.parent.$loader.removeClass("hidden");var e={id:this.payload.id};Craft.postActionRequest("qarr/answers/delete",e,$.proxy(function(e,a){t.parent.$loader.addClass("hidden"),e.success&&(Craft.cp.displayNotice(Craft.t("qarr","Answer deleted")),t.$item.addClass("item-deleted"),t.$item.velocity("slideUp",{duration:300}))},this))},updateStatus:function(t){var e=this,a=this.statusLabelText.text();this.statusLabelText.velocity("transition.fadeOut",{duration:350,complete:function(){e.statusLabelText.html(t.status),e.$statusLabel.removeClass("status-"+a),e.$statusLabel.addClass("status-"+t.status),e.statusLabelText.velocity("transition.fadeIn",{duration:100})}})}});
